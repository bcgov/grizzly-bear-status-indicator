---
output: 
html_document:
  css: "assets/grizzleaflet_style.css"
params:
  add_popups: true
---
<!--
Copyright 2018 Province of British Columbia
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r leaflet, include = FALSE}

# # Loading R libraries
Packages <- c("sf", "tidyverse", "maptools", "devtools","bcmaps", "htmltools", "here",
              "ggplot2", "leaflet", "rmapshaper", "bcdata", "envreportutils","viridis")
lapply(Packages, library, character.only = TRUE)

# Load grizzly bear population unit polygons as an sf object
popunits <- bcdc_get_geodata("grizzly-bear-population-units",
                             query = "VERSION_NAME='2012'")

# Load grizzly 
grizzlypop_raw <- read_csv("https://catalogue.data.gov.bc.ca/dataset/2bf91935-9158-4f77-9c2c-4310480e6c29/resource/4eca8c5c-ed25-46c1-835c-3d9f84b807e1/download/grizzlypopulationestimate2012.csv")
glimpse(grizzlypop_raw)


# Simplify population unit polygons using mapshaper
popunits_simplify <- ms_simplify(popunits, keep = 0.25) %>% # reduce number of vertices
  st_transform(popunits_simplify, crs = 4326) # change projection

# Drop unused metadata columns
popunits_simplify <- select(popunits_simplify, -c(id, SE_ANNO_CAD_DATA, VERSION_YEAR_MODIFIED, OBJECTID))

# Find centroid of polygons (for labelling)
# Note: 'popunits' w/ BC Albers CRS used because lat/long not accepted by st_centroid
popcentroid <- st_centroid(popunits$geometry)
popcentroid <- st_transform(popcentroid, crs = 4326) # convert to lat/long

# Calculate coordinates for centroid of polygons
popcoords <- st_coordinates(popcentroid) # changes to a matrix

# Spatial join
popunits_xy <- cbind(popunits_simplify, popcoords) # cbind coords and polygons

# Rename lat and lng columns
popunits_xy <- rename(popunits_xy, lng = X)
popunits_xy <- rename(popunits_xy, lat = Y)


# Set column names to lower case
popunits_xy <- popunits_xy %>% rename_all(tolower) %>%
  st_transform(popunits_xy, crs = 4326) # convert to lat/long

by_gbpu <- grizzlypop_raw %>%
  group_by(GBPU) %>%
  summarise(POP_ESTIMATE = sum(Estimate), POP_DENSITY = sum(Density)) %>% # Does this make sense to sum up density?
  rename(POPULATION_NAME = GBPU) %>%
  rename_all(tolower) # Set to lower case
glimpse(by_gbpu)

# Join population + density estimates
popunits_xy <- left_join(popunits_xy, by_gbpu, by = "population_name")
```

# Setup
``` {r, warning = FALSE}

plot_list = list()
if (params$add_popups) {
  # get plot list 
  plot_list <- readRDS(here("tmp/plotlist.rds"))[popunits_xy$population_name]
}

popupGraph_list <- imap(plot_list, ~ {
    .x$barchart + 
      .x$map +
      plot_layout(widths = c(1, 1.5)) +
      plot_annotation(title = tools::toTitleCase(tolower(.y)),
                      theme = theme(title = element_text(size = 18)))
  })
  
popups <-  popupGraph(popupGraph_list, type = "svg", width = 700,
                        height = 400)
popup_options <-  popupOptions(maxWidth = "100%", autoPan = TRUE,
                                 keepInView = TRUE,
                                 zoomAnimation = FALSE,
                                 closeOnClick = TRUE,
                                 autoPanPaddingTopLeft = c(120, 10),
                                 autoPanPaddingBottomRight = c(10,10))
} else {
  popups <- popup_options <- NULL
}
```

``` {r leaflet, warning = F}
grizzmap <- leaflet() %>%   # generate leaflet map
  addProviderTiles(providers$Stamen.TerrainBackground, group = "Terrain") %>%
  addTiles(group = "OSM (Default") %>%
  add_bc_home_button() %>%
  set_bc_view_on_close() %>% # re-centre map on popup close
  addLegend("bottomright", pal = factpal, values = grizzdata$status,
            title = "Population Status",
            opacity = 1) %>%
  addPolygons(data = grizzdata,
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.4, # Polygon fill
              fillColor = ~factpal(grizzdata$status),
              highlight = highlightOptions( # Highlight interaction for mouse hover
                weight = 4,
                color = "yellow",
                bringToFront = T)) %>%
  addLayersControl(
    baseGroups = c("Terrain", "OSM (Default")) %>%
  addMarkers(data = grizzdata, lng = ~lng, lat = ~lat,
             label = grizzdata$population_name, icon = tree,
             labelOptions = labelOptions(noHide = F, textOnly = F))
grizzmap # View leaflet

```

```{r leaflet printout, include=TRUE}
grizzmap # View leaflet
```
