---
output:
  html_document:
    css: "assets/leaflet_style.css"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)

# Tidyverse
library(tidyverse)

# Mapping
library(leaflet)
library(sf)
library(geojsonio)
library(htmltools)
library(mapview)
library(DT)

# SOE + popups
library(envreportutils)

# Load data
grizzdata_full <- read_rds(here("data/grizzdata_full.rds"))
grizzdata_full <- st_transform(grizzdata_full, crs = 4326) # convert to lat/long

# Summary data for popups
grizz_summary <- dplyr::select(grizzdata_full, gbpu_name, status, adults, 
                               popiso, threat_class) %>%
  rename("Population Name" = gbpu_name,
         "Overall Status" = status,
         "Population Size" = adults,
         "Isolation" = popiso,
         "Threat Class" = threat_class) # add trend - not found? 

st_geometry(grizz_summary) <- NULL # as df

# dt option - scratch
grizz_dt <- datatable(grizz_summary, width = 500)

# Popups
popups <- read_rds(here("out/grizz_popups2.rds"))
popup_table <- leafpop::popupTable(grizz_summary,
                                   row.numbers = F, 
                                   feature.id = F)

popup_options <-  popupOptions(autoPan = TRUE,
                               keepInView = TRUE,
                               closeOnClick = TRUE,
                               autoPanPaddingTopLeft = c(120, 10),
                               autoPanPaddingBottomRight = c(120,10))

plotlabs <- sprintf( # create labels for leaflet map
  "<strong>%s</strong>",
  tools::toTitleCase(tolower(grizzdata_full$gbpu_name))
) %>% lapply(htmltools::HTML)

# Prep - colour palettes
palette1 <- colorFactor(palette = 'viridis', grizzdata_full$rankcode,
                        reverse = TRUE, na.color = "#808080")

palette2 <- colorNumeric("PuBuGn", grizzdata_full$pop_density,
                         na.color = "#808080")
palette3 <- colorFactor("RdBu", grizzdata_full$threat_class,
                        na.color = "#808080")
```

# {.tabset .tabset-fade}

```{r grizz_map, warning=FALSE, echo=FALSE}
grizzmap <- leaflet(width = "900px", height = "500px") %>%  # generate leaflet map
  addProviderTiles(providers$Stamen.Terrain, group = "Terrain") %>%
  add_bc_home_button() %>%
  set_bc_view()

```

## Conservation Status

```{r, warning=FALSE, echo=FALSE}
grizzmap %>% 
  addPolygons(data = grizzdata_full, #group = "Conservation Status",
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.7, # Polygon fill
              fillColor = ~palette1(grizzdata_full$calcrank),
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              popup = popup_table,
              popupOptions = popup_options,
              highlight = highlightOptions( # Highlight interaction for mouse hover
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLegend("bottomright", pal = palette1, values = grizzdata_full$calcrank,
            title = "Conservation Status", na.label = "Extirpated",
            opacity = 1) #%>%
  #addLayersControl(overlayGroups = c("Terrain", "Topography"))
```

## Population Density Estimate

``` {r, warning=FALSE, echo=FALSE}
grizzmap %>%
  addPolygons(data = grizzdata_full, #group = "Population Estimate",
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.6,
              fillColor = ~palette2(grizzdata_full$pop_density),
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              popup = popups,
              popupOptions = popup_options,
              highlight = highlightOptions( # Highlight interaction for mouse hover
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLegend("bottomright", pal = palette2, values = grizzdata_full$pop_density,
            title = "Population Density",
            opacity = 1) #%>%
  #addLayersControl(overlayGroups = c("Terrain", "Topography"))
```

## Threat Classification

``` {r, warning=FALSE, echo=FALSE}
grizzmap %>% 
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.7, # Polygon fill
              fillColor = ~palette3(grizzdata_full$transportationcalc),
              #popup = popups,
              #popupOptions = popup_options,
              group = "Transportation",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions( # Highlight interaction for mouse hover
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$energycalc),
              group = "Energy",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$humanintrusioncalc),
              group = "Human Intrusion",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$residentialcalc),
              group = "Residential",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$agriculturecalc),
              group = "Agriculture",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$biousecalc),
              group = "Biouse",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.7,
              fillColor = ~palette3(grizzdata_full$climatechangecalc),
              group = "Climate Change",
              label = plotlabs,
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlight = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLayersControl(
    baseGroups = c("Transportation", "Energy", "Human Intrusion", "Residential",
                   "Agriculture", "Biouse", "Climate Change"),
    #overlayGroups = c("Terrain", "OSM (Default)"),
    options = layersControlOptions(collapsed = FALSE)) %>%
  addLegend("bottomright", pal = palette3, values = grizzdata_full$threat_class,
            title = "Threat Rank",
            opacity = 1)
#%>%
  #addLayersControl(overlayGroups = c("Terrain", "Topography"))
```
