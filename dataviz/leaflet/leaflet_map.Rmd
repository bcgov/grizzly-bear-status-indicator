---
output:
  html_document:
    css: "assets/leaflet_style.css"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(leaflet)
library(leafpop)
library(sf)

# SOE + popups
library(envreportutils)

# Load data
grizzdata_full <- read_rds(here("data/grizzdata_full.rds"))
grizzdata_full <- st_transform(grizzdata_full, crs = 4326) # convert to lat/long

```

```{r popups, include=FALSE, warning=FALSE}

## TEXT POPUPS

# conservation status tab:
popup_text1 <- grizzdata_full %>% 
  select("Population Name" = gbpu_name,
         "Management Rank" = calcsrank,
         "Overall Threat Score" = threat_class,
         "Population Size" = adults,
         "Isolation" = isolation,
         "Trend" = trend) 
 
st_geometry(popup_text1) <- NULL # as df

constatus_popup <- leafpop::popupTable(popup_text1,
                                   row.numbers = F, 
                                   feature.id = F)

mrank_plot_paths <- paste0("<img src = ", 
                        paste0("./concern_plots/", 
                               gsub("\\s+", "%20", grizzdata_full$gbpu_name), ".svg"), 
                        ">")

## Insert img tag with path to M Rank plots in html string before the end
constatus_popup <- str_replace(constatus_popup, "</div></body></html>", 
                               paste0(mrank_plot_paths, "</div></body></html>"))

# Popup for population tab
popup_text2 <- grizzdata_full %>% 
  select("Population Name" = gbpu_name,
         "Population Size (Adults)" = adults,
         "Population Density (Adults/1000 km^2)" = pop_density,
         "Area of Useable Habitat (km2)" = use_area_sq_km,
         "Total Area of GBPU (km^2)" = area_sq_km) 

st_geometry(popup_text2) <- NULL # as df

population_popup <- leafpop::popupTable(popup_text2,
                                   row.numbers = F, 
                                   feature.id = F)

# Threat popups
threat_popups <- paste0("<img src = ", 
                        paste0("./threat_plots/", 
                               gsub("\\s+", "%20", grizzdata_full$gbpu_name), ".svg"), 
                        ">")

# Define popup options
popup_options <-  popupOptions(maxWidth = 400, minWidth = 400, maxHeight = 300,
                               autoPan = TRUE,
                               keepInView = TRUE,
                               closeOnClick = TRUE,
                               autoPanPaddingTopLeft = c(120, 20),
                               autoPanPaddingBottomRight = c(150,20))

```

``` {r labels and palettes, include=FALSE, warning=FALSE}
# Define polygon labels in leaflet
labs <- dplyr::select(grizzdata_full, gbpu_name, pop_density, calcsrank, threat_class)

st_geometry(labs) <- NULL # as df

lab1 <- lapply(seq(nrow(labs)), function(i) {
  paste0( '<b>', labs[i, "gbpu_name"], ', ',  
          labs[i, "calcsrank"], '</b>') 
})

lab2 <- lapply(seq(nrow(labs)), function(i) {
  paste0( '<b>', labs[i, "gbpu_name"], ', ',  
          labs[i, "pop_density"]," Adults/1000km2",'</b>') 
})

lab3 <- lapply(seq(nrow(labs)), function(i) {
  paste0( '<b>', labs[i, "gbpu_name"], ', ',  
          labs[i, "threat_class"], '</b>') 
})

# Prep colour palettes
palette1 <- colorFactor(palette = 'viridis', grizzdata_full$calcsrank, reverse = TRUE)
palette2 <- colorNumeric(palette = 'viridis', grizzdata_full$pop_density, reverse = TRUE)
palette3 <- colorFactor(palette = 'viridis', grizzdata_full$threat_class, reverse = TRUE)

```

# {.tabset .tabset-fade}

```{r grizz_map, warning=FALSE, echo=FALSE}
grizzmap <- leaflet(width = "900px", height = "500px", 
                    options = leafletOptions(minZoom = 5)) %>%  # generate leaflet map
  addProviderTiles(providers$Stamen.Terrain, group = "Terrain") %>%
  add_bc_home_button() %>%
  set_bc_view()

```

## Conservation Concern

```{r, warning=FALSE, echo=FALSE}
grizzmap %>% 
  addPolygons(data = grizzdata_full, group = "Conservation Status",
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.5, # Polygon fill
              fillColor = ~palette1(grizzdata_full$calcsrank),
              label = lapply(lab1, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
             # popup = c(constatus_popup, concern_popups), 
              popup = constatus_popup, 
            #  popupOptions = popup_options,
            #  highlight = highlightOptions( # Highlight interaction for mouse hover
              popupOptions = popupOptions(autoPan = TRUE,
                               keepInView = TRUE,
                               closeOnClick = TRUE),
              highlightOptions = highlightOptions( # Highlight interaction for mouse hover
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLegend("bottomright", pal = palette1, values = grizzdata_full$calcsrank,
            title = "Management Rank", na.label = "Extirpated",
            opacity = 1) 
```

## Population Density Estimate

``` {r, warning=FALSE, echo=FALSE}
grizzmap %>%
  addPolygons(data = grizzdata_full, group = "Population Density",
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette2(grizzdata_full$pop_density),
              label = lapply(lab2, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              popup = population_popup,
              popupOptions = popupOptions(autoPan = TRUE,
                               keepInView = TRUE,
                               closeOnClick = TRUE),
              highlightOptions = highlightOptions( 
                  weight = 3,
                  color = "yellow",
                  bringToFront = T)) %>%
  addLegend("bottomright", pal = palette2, values = grizzdata_full$pop_density,
            title = "Population Density", na.label = "Extirpated",
            opacity = 1) 

# addLayersControl(overlayGroups = c("Terrain", "Topography"))
```

## Threat Classification

``` {r, warning=FALSE, echo=FALSE}
grizzmap %>% 
    addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.5, # Polygon fill
              fillColor = ~palette3(grizzdata_full$threat_class),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Overall Threat",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions( 
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%

  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.5, # Polygon fill
              fillColor = ~palette3(grizzdata_full$transportationcalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Transportation",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions( 
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$energycalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Energy",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$humanintrusioncalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Human Intrusion",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$residentialcalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Residential",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$agriculturecalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Agriculture",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$biousecalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Biological Use",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addPolygons(data = grizzdata_full,
              stroke = T, weight = 1, color = "black",
              fillOpacity = 0.5,
              fillColor = ~palette3(grizzdata_full$climatechangecalc),
              popup = threat_popups,
              popupOptions = popup_options,
              group = "Climate Change",
              label = lapply(lab3, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              highlightOptions = highlightOptions(
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLayersControl(
    baseGroups = c("Overall Threat","Transportation", "Residential","Human Intrusion", "Energy",  "Climate Change","Biological Use", "Agriculture"),
    options = layersControlOptions(collapsed = FALSE)) %>%
  addLegend("bottomright", pal = palette3, values = grizzdata_full$threat_class,
            title = "Threat Rank", na.label = "Extirpated",
            opacity = 1)

```
